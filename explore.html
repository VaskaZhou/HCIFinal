<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Explore Castle</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Babylon.js -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
    }
    #renderCanvas {
      width: 100%;
      height: 100%;
      touch-action: none;
      display: block;
    }

    /* é­”æ³•å¼¹å‡ºæŒ‰é’® */
    #spotPopup {
      position: absolute;
      transform: translate(-50%, -120%);
      padding: 10px 16px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #ffffffaa, #c18c46);
      color: #fff;
      font-weight: 700;
      box-shadow: 0 0 18px rgba(248, 222, 129, 0.7);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      white-space: nowrap;
    }
    #spotPopup.show {
      opacity: 1;
      transform: translate(-50%, -130%) scale(1.02);
      pointer-events: auto;
    }

    /* å¤å¤é£èµ„æ–™å¡ç‰‡ */
    #detailPanel {
      position: absolute;
      inset: 10% 6%;
      background: #f5e4c7;
      color: #3c2f23;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      border: 2px solid rgba(90, 64, 38, 0.8);
      padding: 20px 18px 70px 18px;
      display: none;
      overflow-y: auto;
      font-family: "Georgia", "Times New Roman", serif;
      background-size: cover;
      background-position: center;
      /* è¿™é‡Œå¯ä»¥æ¢æˆä½ è‡ªå·±çš„å¤å¤çº¸å¼ èƒŒæ™¯å›¾ï¼š
         background-image: url('images/vintage-paper.jpg'); */
    }
    #detailPanel.show {
      display: block;
      animation: panelIn 0.25s ease-out;
    }
    @keyframes panelIn {
      from { opacity: 0; transform: translateY(15px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* å³ä¸Šè§’å…³é—­æŒ‰é’® */
    #detailClose {
      position: absolute;
      top: 14px;
      right: 16px;
      cursor: pointer;
      font-size: 1.1rem;
      color: #5a3a20;
    }

    /* ä¸‹æ–¹æŒ‰é’®åŒºåŸŸ */
    #detailPanel button {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
  </style>
</head>

<body class="relative">

  <!-- 3D åœºæ™¯ -->
  <canvas id="renderCanvas"></canvas>

  <!-- é¡¶éƒ¨æ ‡é¢˜ UI -->
  <header class="absolute top-3 inset-x-0 text-center text-white drop-shadow-lg pointer-events-none">
    <h1 class="text-xl font-serif tracking-wide">Explore the Castle</h1>
    <p class="text-xs opacity-80">Drag to rotate. Tap to discover a spot.</p>
  </header>

  <!-- é­”æ³•å¼¹å‡ºæŒ‰é’®ï¼ˆç‚¹å‡»æ¨¡å‹åå‡ºç°ï¼‰ -->
  <div id="spotPopup">
    <span id="spotPopupLabel">Gate</span>
  </div>

  <!-- å¤å¤èµ„æ–™å¡ç‰‡ -->
  <div id="detailPanel">
    <div id="detailClose">âœ–</div>
    <h2 id="detailTitle" class="text-2xl mb-3 underline decoration-amber-800 decoration-2">
      Gate
    </h2>
    <p id="detailBody" class="text-sm leading-relaxed mb-4">
      Placeholder text for this location.
    </p>

    <div class="mt-4 text-sm space-y-1">
      <p id="detailExtra1">â€¢ Opening hours and accessibility notes.</p>
      <p id="detailExtra2">â€¢ Small historical anecdote or story hook.</p>
    </div>

    <div class="mt-6 flex justify-end">
      <button id="addToRouteBtn"
              class="bg-amber-800 text-amber-50 px-4 py-2 rounded-full text-sm font-semibold hover:bg-amber-900 transition">
        â• Add this spot to My Route
      </button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("renderCanvas");
    const popup = document.getElementById("spotPopup");
    const popupLabel = document.getElementById("spotPopupLabel");
    const detailPanel = document.getElementById("detailPanel");
    const detailTitle = document.getElementById("detailTitle");
    const detailBody = document.getElementById("detailBody");
    const detailExtra1 = document.getElementById("detailExtra1");
    const detailExtra2 = document.getElementById("detailExtra2");
    const detailClose = document.getElementById("detailClose");
    const addToRouteBtn = document.getElementById("addToRouteBtn");

    // ç®€å•åœ°ç‚¹æ•°æ®ï¼ˆprototype æ–‡æœ¬ï¼‰
    const spotInfo = {
      "Gate": {
        label: "ğŸšª Gate",
        title: "Main Gate",
        body: "The main entrance where visitors first step into the world of Casa Loma. Many formal arrivals and quiet goodbyes happened here.",
        extra1: "â€¢ Often used as the meeting point for guided tours.",
        extra2: "â€¢ A good place to start your journey and orient yourself."
      },
      "Stable": {
        label: "ğŸ´ Stable",
        title: "Castle Stables",
        body: "Once home to the estateâ€™s prized horses, the stable still echoes with the rhythm of carriages and hoofbeats.",
        extra1: "â€¢ Notice the original tilework and iron fittings.",
        extra2: "â€¢ Stories of the staff who worked here add life to the space."
      },
      "Garden": {
        label: "ğŸŒ¸ Garden",
        title: "Lower Garden",
        body: "A quiet refuge of flowers, stone paths, and seasonal displays. The garden was designed as a private escape from the city.",
        extra1: "â€¢ Ideal for photos and a short break from indoor halls.",
        extra2: "â€¢ In some seasons, live events and music take place here."
      },
      "Dining Hall": {
        label: "ğŸ½ï¸ Dining Hall",
        title: "Grand Dining Hall",
        body: "The heart of formal gatherings, where guests were welcomed with multi-course meals under glittering chandeliers.",
        extra1: "â€¢ Look up at the ceiling details and carved wood panels.",
        extra2: "â€¢ Imagine the sound of clinking glasses and live music."
      },
      "Cellar": {
        label: "ğŸ· Cellar",
        title: "Wine Cellar",
        body: "Cool, quiet, and hidden belowâ€”this cellar once stored carefully selected wines for the castleâ€™s grand dinners.",
        extra1: "â€¢ The temperature and layout were designed for preservation.",
        extra2: "â€¢ Perfect place to introduce stories of trade and travel."
      }
    };

    let engine, scene, camera;
    let currentSpotName = null; // å½“å‰å¼¹å‡ºçš„åœ°ç‚¹

    // Babylon åœºæ™¯
    function createScene() {
      engine = new BABYLON.Engine(canvas, true);
      scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color4(0, 0, 0, 1);
      // è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå¤©ç©ºèƒŒæ™¯ï¼ˆå†…ç½®çš„ï¼‰
      BABYLON.CubeTexture.CreateFromPrefilteredData("https://assets.babylonjs.com/environments/environmentSpecular.env", scene);
      scene.environmentTexture = BABYLON.CubeTexture.CreateFromPrefilteredData("https://assets.babylonjs.com/environments/environmentSpecular.env", scene);
      scene.createDefaultSkybox(scene.environmentTexture, true, 1000, 0.3);


      // ç›¸æœºï¼šæ°´å¹³æ—‹è½¬ï¼Œå‚ç›´è§’åº¦åŸºæœ¬é”æ­»
      camera = new BABYLON.ArcRotateCamera(
        "camera",
        Math.PI * 1.5,        // alpha
        Math.PI / 3,        // beta
        18,                 // radius
        new BABYLON.Vector3(0, -1, 0),
        scene
      );
      camera.attachControl(canvas, true);
      camera.lowerBetaLimit = Math.PI / 3;
      camera.upperBetaLimit = Math.PI / 3; // é”å®šå‚ç›´è§’åº¦ï¼Œåªèƒ½æ°´å¹³è½¬

      const light = new BABYLON.HemisphericLight(
        "light",
        new BABYLON.Vector3(1, 1, 0),
        scene
      );
      light.intensity = 0.9;

      // åŠ è½½ GLB æ¨¡å‹ï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰
    BABYLON.SceneLoader.ImportMeshAsync(
    "",          // meshNames (ç©ºè¡¨ç¤ºåŠ è½½å…¨éƒ¨)
    "/models/",   // æ–‡ä»¶è·¯å¾„
    "castle.glb",// æ–‡ä»¶å
    scene
    ).then(result => {
    const rootMesh = result.meshes[0]; // é€šå¸¸ç¬¬ä¸€ä¸ªæ˜¯æ ¹èŠ‚ç‚¹
    rootMesh.scaling = new BABYLON.Vector3(1, 1, 1);  // è°ƒæ•´ç¼©æ”¾å¤§å°
    rootMesh.position = new BABYLON.Vector3(0, 0, 0); // è°ƒæ•´ä½ç½®åˆ°åœ°é¢ä¸­å¿ƒ
    rootMesh.rotation = new BABYLON.Vector3(0, Math.PI, 0); // è°ƒæ•´æœå‘ï¼ˆæŒ‰éœ€ä¿®æ”¹ï¼‰
    });


      // å››ä¸ªç®€æ˜“å¡”æ¥¼ + ä¸€å—åæ–¹åŒºåŸŸï¼Œä»£è¡¨ 5 ä¸ªåœ°ç‚¹
      const spots = [];

      function createSpotBox(name, pos, size = { width: 3, height: 3, depth: 3 }) {
        const box = BABYLON.MeshBuilder.CreateBox(name, {
            width: size.width,
            height: size.height,
            depth: size.depth
        }, scene);

        box.position = pos;

        const m = new BABYLON.StandardMaterial(name + "Mat", scene);
        m.diffuseColor = new BABYLON.Color3(0.4, 0.7, 1.0); // æ·¡è“è‰²
        m.alpha = 0.0;  // âœ… åŠé€æ˜
        box.material = m;
        box.metadata = { spotName: name };

        return box;
        }


      createSpotBox("Gate",         new BABYLON.Vector3(0, -1, 0), { width: 3, height: 2, depth: 2 });
      createSpotBox("Stable",       new BABYLON.Vector3(10, -1, -3), { width: 3, height: 4, depth: 8 });
      createSpotBox("Garden",       new BABYLON.Vector3(-1, -1, 7), { width: 7, height: 2, depth: 4 });
      createSpotBox("Dining Hall",  new BABYLON.Vector3(-2, 0, 2), { width: 3, height: 3, depth: 3 });
      createSpotBox("Cellar",       new BABYLON.Vector3(-3, -2, 0), { width: 3, height: 3, depth: 3 });

      // ç‚¹å‡»æ‹¾å–
      scene.onPointerObservable.add(pointerInfo => {
        if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERDOWN) {
          const pickResult = pointerInfo.pickInfo || scene.pick(
            scene.pointerX,
            scene.pointerY
          );

          if (pickResult && pickResult.hit && pickResult.pickedMesh && pickResult.pickedMesh.metadata && pickResult.pickedMesh.metadata.spotName) {
            const spotName = pickResult.pickedMesh.metadata.spotName;
            currentSpotName = spotName;
            showPopupForMesh(pickResult.pickedMesh);
          } else {
            hidePopup();
          }
        }
      });

      engine.runRenderLoop(() => {
        scene.render();
        // å¦‚æœå¼¹å‡ºæŒ‰é’®æ˜¾ç¤ºç€ï¼Œæ¯å¸§éƒ½é‡æ–°æ›´æ–°ä½ç½®ï¼Œé˜²æ­¢ç”¨æˆ·æ—‹è½¬æ—¶é”™ä½
        if (popup.classList.contains("show") && currentSpotName) {
          const mesh = scene.getMeshByName(currentSpotName);
          if (mesh) {
            positionPopupOverMesh(mesh);
          }
        }
      });

      window.addEventListener("resize", () => engine.resize());
      return scene;
    }

    // è®¡ç®—æŒ‰é’®ä½ç½®
    function positionPopupOverMesh(mesh) {
      const pos = mesh.getBoundingInfo().boundingBox.centerWorld;
      const projected = BABYLON.Vector3.Project(
        pos,
        BABYLON.Matrix.Identity(),
        scene.getTransformMatrix(),
        camera.viewport.toGlobal(engine.getRenderWidth(), engine.getRenderHeight())
      );
      popup.style.left = projected.x + "px";
      popup.style.top  = projected.y + "px";
    }

    function showPopupForMesh(mesh) {
      const spotName = mesh.metadata.spotName;
      const info = spotInfo[spotName];
      popupLabel.textContent = info ? info.label : spotName;
      positionPopupOverMesh(mesh);
      popup.classList.add("show");
    }

    function hidePopup() {
      popup.classList.remove("show");
      currentSpotName = null;
    }

    // ç‚¹å‡»å¼¹å‡ºæŒ‰é’® â†’ æ‰“å¼€èµ„æ–™å¡ç‰‡
    let popupClickable = true; // ç‚¹å‡»å†·å´é”

    popup.addEventListener("click", () => {
    if (!popupClickable || !currentSpotName) return;

    const info = spotInfo[currentSpotName];
    if (!info) return;

    detailTitle.textContent = info.title;
    detailBody.textContent = info.body;
    detailExtra1.textContent = info.extra1;
    detailExtra2.textContent = info.extra2;
    detailPanel.classList.add("show");
    popup.classList.remove("show");
    });

    // åœ¨ showPopupForMesh() é‡ŒåŠ ä¸Šç‚¹å‡»å†·å´ï¼š
    function showPopupForMesh(mesh) {
    const spotName = mesh.metadata.spotName;
    const info = spotInfo[spotName];
    popupLabel.textContent = info ? info.label : spotName;
    positionPopupOverMesh(mesh);
    popup.classList.add("show");

    // ä¸´æ—¶ç¦ç”¨æŒ‰é’®ç‚¹å‡» 400msï¼Œé˜²æ­¢è§¦æ§ç©¿é€
    popupClickable = false;
    setTimeout(() => popupClickable = true, 400);
    }

    // å…³é—­èµ„æ–™å¡ç‰‡
    detailClose.addEventListener("click", () => {
      detailPanel.classList.remove("show");
    });

    // ç‚¹å‡»â€œAdd to Routeâ€ â†’ è·³è½¬åˆ° Route Planner å¹¶ä¼ é€’åœ°ç‚¹
    addToRouteBtn.addEventListener("click", () => {
      if (!currentSpotName) return;
      const encoded = encodeURIComponent(currentSpotName);
      window.location.href = `route.html?add=${encoded}`;
    });

    // åˆå§‹åŒ–åœºæ™¯
    createScene();
  </script>
</body>
</html>
